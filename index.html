<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¡çœ å•å·ï¼ˆAPSï¼‰</title>

<style>
  body {
    font-size: 20px;
    max-width: 800px;
    margin: auto;
    line-height: 1.8;
  }
  @media (max-width: 900px) {
    body { font-size: 21px; }
  }
  @media (max-width: 600px) {
    body { font-size: 22px; }
  }
  .question { margin-bottom: 25px; }
  button {
    font-size: 18px;
    padding: 4px 10px;
    margin-left: 6px;
  }
  .option label {
    display: block;
    margin-left: 20px;
  }
</style>
</head>

<body>

<h1>ç¡çœ å•å·</h1>

<h2>[0] åŸºæœ¬è³‡æ–™</h2>

<div class="question">
  å§“åï¼ˆå¿…å¡«ï¼‰<br>
  <input type="text" id="name">
</div>

<div class="question">
  æ€§åˆ¥ï¼ˆå¿…å¡«ï¼‰<br>
  <label><input type="radio" name="gender" value="ç”·"> ç”·</label>
  <label><input type="radio" name="gender" value="å¥³"> å¥³</label>
</div>

<div class="question">
  å¹´é½¡ï¼ˆå¿…å¡«ï¼‰<br>
  <input type="number" id="age">
</div>

<hr>

<h2>[1] å–šé†’å‚¾å‘é‡è¡¨ï¼ˆAPSï¼‰</h2>

<div id="aps-container"></div>

<button onclick="submitForm()">é€å‡º</button>

<script>
  // ===== è¡Œç‚º logï¼ˆPhase 1ï¼šå…¨å•å·å±¤ç´šï¼‰=====
const surveyStartTime = Date.now();
let ttsCount = 0;
let ttsLog = [];
// ===== å–®é¡Œåæ‡‰æ™‚é–“ï¼ˆç¬¬ä¸€æ¬¡ä½œç­”ï¼‰=====
const apsFirstResponseTime = {}; // { APS1: ms, APS2: ms, ... }


const apsQuestions = [
  "æˆ‘æ˜¯ä¸€å€‹éå¸¸å†·éœçš„äººã€‚",
  "æˆ‘åœ¨ç…©èºä¸å®‰å¾Œéœ€è¦å¾ˆé•·æ™‚é–“æ‰èƒ½æ”¾é¬†ã€‚",
  "ç•¶æˆ‘èˆˆå¥®æ™‚ï¼Œå¾ˆé›£å…¥ç¡ã€‚",
  "ç•¶æˆ‘èˆˆå¥®æ™‚ï¼Œæˆ‘çš„å¿ƒè·³æ¯”å¤§å¤šæ•¸äººå¿«ã€‚",
  "å¤œæ™šæˆ‘å°å™ªéŸ³éå¸¸æ•æ„Ÿã€‚",
  "æˆ‘å¾ˆå®¹æ˜“è¢«çªå¦‚å…¶ä¾†çš„è²éŸ³åš‡åˆ°ã€‚",
  "æˆ‘çš„æƒ…ç·’å¾€å¾€éå¸¸å¼·çƒˆã€‚",
  "æˆ‘å°å¼·å…‰éå¸¸æ•æ„Ÿã€‚",
  "ç¶“æ­·å£“åŠ›äº‹ä»¶å¾Œï¼Œæˆ‘éœ€è¦å¾ˆé•·æ™‚é–“æ‰èƒ½å¹³éœä¸‹ä¾†ã€‚",
  "æˆ‘è¦ºå¾—ã€Œè¼•é¬†ç”Ÿæ´»ã€å¾ˆå®¹æ˜“ã€‚",
  "æˆ‘çš„è‚Œè‚‰ç¶“å¸¸æ„Ÿè¦ºç·Šå¼µæˆ–ç·Šç¹ƒã€‚",
  "æˆ‘ç¶“å¸¸æ„Ÿåˆ°ã€Œç·Šå¼µå…®å…®ã€æˆ–ç·Šç¹ƒã€‚"
];

const options = ["å¹¾ä¹å¾ä¸","å¾ˆå°‘","å¶çˆ¾","å¸¸å¸¸","å¹¾ä¹ç¸½æ˜¯"];

const container = document.getElementById("aps-container");

apsQuestions.forEach((q, i) => {
  const div = document.createElement("div");
  div.className = "question";
  div.innerHTML = `
    ${i+1}. ${q}
    <button type="button" onclick="speak('${q}',1)">ğŸ”Š æ­£å¸¸</button>
    <button type="button" onclick="speak('${q}',0.6)">ğŸ¢ æ…¢é€Ÿ</button>
    <div class="option">
      ${options.map((opt, v) => `
        <label>
          <input type="radio" name="APS${i+1}" value="${v+1}" onchange="recordAPSResponse(${i+1})"> ${opt}
        </label>`).join("")}
    </div>
  `;
  container.appendChild(div);
});

function recordAPSResponse(itemNumber) {
  const key = "APS" + itemNumber;

  // åªè¨˜ç¬¬ä¸€æ¬¡åæ‡‰
  if (!apsFirstResponseTime[key]) {
    apsFirstResponseTime[key] = Date.now() - surveyStartTime;
  }
}


// ç©©å®šç‰ˆèªéŸ³æœ—è®€
function speak(text, rate) {
  const synth = window.speechSynthesis;
  synth.cancel();

  // ===== è¡Œç‚ºè¨˜éŒ„ =====
  ttsCount++;
  ttsLog.push({
    item: apsQuestions.indexOf(text) + 1,
    text: text,
    rate: rate,
    time: new Date().toISOString()
  });

  setTimeout(() => {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-TW";
    u.rate = rate;
    synth.speak(u);
  }, 120);
}


// é€å‡ºè¡¨å–®
function submitForm() {
  const name = document.getElementById("name").value.trim();
  const age = document.getElementById("age").value;
  const gender = document.querySelector('input[name="gender"]:checked');

  if (!name || !age || !gender) {
    alert("è«‹å®Œæ•´å¡«å¯«åŸºæœ¬è³‡æ–™");
    return;
  }

  for (let i=1;i<=12;i++) {
    if (!document.querySelector(`input[name="APS${i}"]:checked`)) {
      alert(`ç¬¬ ${i} é¡Œå°šæœªä½œç­”`);
      return;
    }
  }

  const surveyEndTime = Date.now();

  const data = {
    name: name,
    age: age,
    gender: gender.value,

    // ===== è¡Œç‚º log =====
    start_time: new Date(surveyStartTime).toISOString(),
    end_time: new Date(surveyEndTime).toISOString(),
    total_time_sec: Math.round((surveyEndTime - surveyStartTime) / 1000),
    tts_count: ttsCount,
    tts_detail: JSON.stringify(ttsLog)

    // ===== å–®é¡Œåæ‡‰æ™‚é–“ï¼ˆç§’ï¼‰=====
    for (let i = 1; i <= 12; i++) {
     const key = "APS" + i;
     data[key + "_time_sec"] = apsFirstResponseTime[key]
        ? Math.round(apsFirstResponseTime[key] / 1000)
        : "";
    }
  };


  for (let i=1;i<=12;i++) {
    data["APS"+i] = document.querySelector(`input[name="APS${i}"]:checked`).value;
  }

  fetch("https://script.google.com/macros/s/AKfycby4crki8fOXzSNA-CmzDqKC-VBPIq59bn_C96HHxjGc4DAqTPHRgnPEp7AMuNem-6380g/exec", {
    method: "POST",
    body: JSON.stringify(data)
  }).then(()=>alert("å·²é€å‡ºï¼Œæ„Ÿè¬å¡«å¯«"));
}
</script>

</body>
</html>
